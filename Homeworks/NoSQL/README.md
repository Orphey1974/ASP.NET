# NoSQL Integration - MongoDB + Redis

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å PostgreSQL –Ω–∞ MongoDB –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π —Å Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

# Otus.PromoCodeFactory

–ü—Ä–æ–µ–∫—Ç –¥–ª—è –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –∏ –¥–µ–º–æ –ø–æ –∫—É—Ä—Å—É `C# ASP.NET Core –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫` –æ—Ç `–û—Ç—É—Å`.
C–∏—Å—Ç–µ–º–∞ `Promocode Factory` –¥–ª—è –≤—ã–¥–∞—á–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π.

## üÜï –ù–æ–≤—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å: Pcf.Preferences

–î–æ–±–∞–≤–ª–µ–Ω –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:
- **–ü–æ—Ä—Ç**: 8094
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: SQLite
- **–ö—ç—à**: Redis (–ø—Ä–æ–¥–∞–∫—à–Ω) / In-Memory (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
- **API**: RESTful –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º–∏

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ MongoDB
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Entity Framework
- ‚úÖ –£–¥–∞–ª–µ–Ω PostgreSQL –∏–∑ docker-compose
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã EF —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã –º–æ–¥–µ–ª–∏ –¥–ª—è MongoDB (EmployeeDocument, RoleDocument)
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å MongoDB
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ç–æ–ª—å–∫–æ —Å MongoDB
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–æ–ª—å–∫–æ –¥–ª—è MongoDB
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è MongoDB

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (—Ç–æ–ª—å–∫–æ MongoDB)
- **–î–æ–∫—É–º–µ–Ω—Ç—ã MongoDB**: `EmployeeDocument`, `RoleDocument`
- **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏**: `MongoEmployeeRepository`, `MongoRoleRepository`
- **–ú–∞–ø–ø–µ—Ä—ã**: `EmployeeMapper`, `RoleMapper`
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç**: `MongoDbContext`
- **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ç–æ—Ä**: `MongoDbInitializer`

## –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

### 1. –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ MongoDB

```bash
docker-compose up promocode-factory-administration-mongodb
```

### 2. –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
docker-compose up
```

### 3. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Visual Studio/Rider
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ MongoDB (–∫–æ–º–∞–Ω–¥–∞ –≤—ã—à–µ)
2. –û—Ç–∫—Ä–æ–π—Ç–µ —Ä–µ—à–µ–Ω–∏–µ `Pcf.Administration.sln`
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç `Pcf.Administration.WebHost`

## API Endpoints

### –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (MongoDB) - –ü–æ—Ä—Ç 8091
- `GET /api/v1/employees` - –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- `GET /api/v1/employees/{id}` - –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ ID
- `POST /api/v1/employees/{id}/appliedPromocodes` - –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

### –†–æ–ª–∏ (MongoDB) - –ü–æ—Ä—Ç 8091
- `GET /api/v1/roles` - –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ä–æ–ª–∏

### –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è (SQLite + Redis) - –ü–æ—Ä—Ç 8094
- `GET /api/v1/preferences` - –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
- `GET /api/v1/preferences/{id}` - –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –ø–æ ID
- `POST /api/v1/preferences` - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ
- `PUT /api/v1/preferences/{id}` - –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ
- `DELETE /api/v1/preferences/{id}` - –£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### MongoDB –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```json
{
  "MongoDbSettings": {
    "ConnectionString": "mongodb://admin:password@localhost:27017",
    "DatabaseName": "promocode_factory_administration"
  }
}
```

### Docker Compose
- **MongoDB**: –ø–æ—Ä—Ç 27017
- **Redis**: –ø–æ—Ä—Ç 6379
- **Administration API**: –ø–æ—Ä—Ç 8091
- **Preferences API**: –ø–æ—Ä—Ç 8094

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Administration API (MongoDB)
1. –û—Ç–∫—Ä–æ–π—Ç–µ Swagger UI: `https://localhost:8091/swagger`
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ endpoints –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Ä–æ–ª–µ–π
3. –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ MongoDB

### Preferences API (SQLite + Redis)
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å: `dotnet run --project src/Pcf.Preferences/Pcf.Preferences.WebHost`
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ API: `http://localhost:8094/api/v1/preferences`
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç: `./test-preferences-api.ps1`

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### EmployeeDocument
```json
{
  "_id": "ObjectId",
  "firstName": "string",
  "lastName": "string",
  "email": "string",
  "roleId": "ObjectId",
  "appliedPromocodesCount": "number",
  "fullName": "string" // –≤—ã—á–∏—Å–ª—è–µ–º–æ–µ –ø–æ–ª–µ
}
```

### RoleDocument
```json
{
  "_id": "ObjectId",
  "name": "string",
  "description": "string"
}
```

### Preference (SQLite)
```json
{
  "Id": "Guid",
  "Name": "string",
  "Description": "string"
}
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è**: –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω Entity Framework –∏ PostgreSQL –∏–∑ Administration
2. **MongoDB**: Administration —Ä–∞–±–æ—Ç–∞–µ—Ç –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ —Å MongoDB
3. **Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: Preferences –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Redis –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
4. **–ì–∏–±–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ Redis, —Ç–∞–∫ –∏ in-memory –∫—ç—à–∞
5. **–ú–∞–ø–ø–∏–Ω–≥**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–∞–ø–ø–µ—Ä—ã –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –º–µ–∂–¥—É –¥–æ–º–µ–Ω–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
6. **–£–ø—Ä–æ—â–µ–Ω–∏–µ**: –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
7. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–î–ª—è production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ MongoDB
2. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ObjectId
4. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö
5. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
6. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
7. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤**: –û–±–Ω–æ–≤–∏—Ç—å GivingToCustomer –∏ ReceivingFromPartner –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
8. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—ç—à–∞**: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è Redis –∫—ç—à–∞
9. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –î–æ–±–∞–≤–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é