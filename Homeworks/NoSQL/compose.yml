services:
  #Administration MongoDB
  promocode-factory-administration-mongodb:
    image: "mongo:4.2.3"
    container_name: 'promocode-factory-administration-mongodb'
    restart: always
    ports:
      - 27017:27017
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=password
      - MONGO_INITDB_DATABASE=promocode_factory_administration
    volumes:
      - mongodb_data:/data/db

  #Administration Api
  promocode-factory-administration-api:
    build: src/Pcf.Administration/
    container_name: 'promocode-factory-administration-api'
    restart: always
    ports:
      - "8091:8080"
    environment:
      - "MongoDbSettings:ConnectionString=mongodb://admin:password@promocode-factory-administration-mongodb:27017"
      - "MongoDbSettings:DatabaseName=promocode_factory_administration"
      - "RabbitMqSettings:Host=promocode-factory-rabbitmq"
      - "RabbitMqSettings:Port=5672"
      - "RabbitMqSettings:Username=admin"
      - "RabbitMqSettings:Password=password"
      - "RabbitMqSettings:VirtualHost=/"
    depends_on:
      - promocode-factory-administration-mongodb
      - promocode-factory-rabbitmq

  #ReceivingFromPartner Db
  promocode-factory-receiving-from-partner-db:
    image: "postgres:latest"
    container_name: 'promocode-factory-receiving-from-partner-db'
    restart: always
    ports:
      - 5434:5432
    environment:
      - POSTGRES_PASSWORD=docker
  #ReceivingFromPartner Api
  promocode-factory-receiving-from-partner-api:
    build: src/Pcf.ReceivingFromPartner/
    container_name: 'promocode-factory-receiving-from-partner-api'
    restart: always
    ports:
      - "8092:8080"
    environment:
      - "ConnectionStrings:PromocodeFactoryReceivingFromPartnerDb=Host=promocode-factory-receiving-from-partner-db;Database=promocode_factory_receiving_from_partner_db;Username=postgres;Password=docker"
      - "IntegrationSettings:GivingToCustomerApiUrl=http://promocode-factory-giving-to-customer-api"
      - "IntegrationSettings:AdministrationApiUrl=http://promocode-factory-administration-api"
      - "IntegrationSettings:PreferencesApiUrl=http://promocode-factory-preferences-api:8080"
      - "RabbitMqSettings:Host=promocode-factory-rabbitmq"
      - "RabbitMqSettings:Port=5672"
      - "RabbitMqSettings:Username=admin"
      - "RabbitMqSettings:Password=password"
      - "RabbitMqSettings:VirtualHost=/"
    depends_on:
      - promocode-factory-receiving-from-partner-db
      - promocode-factory-preferences-api
      - promocode-factory-rabbitmq

  #GivingToCustomer Db
  promocode-factory-giving-to-customer-db:
    image: "postgres:latest"
    container_name: 'promocode-factory-giving-to-customer-db'
    restart: always
    ports:
      - 5435:5432
    environment:
      - POSTGRES_PASSWORD=docker
  #GivingToCustomer Api
  promocode-factory-giving-to-customer-api:
    build: src/Pcf.GivingToCustomer/
    container_name: 'promocode-factory-giving-to-customer-api'
    restart: always
    ports:
      - "8093:8080"
    environment:
      - "ConnectionStrings:PromocodeFactoryGivingToCustomerDb=Host=promocode-factory-giving-to-customer-db;Database=promocode_factory_giving_to_customer_db;Username=postgres;Password=docker"
      - "IntegrationSettings:PreferencesApiUrl=http://promocode-factory-preferences-api"
      - "RabbitMqSettings:Host=promocode-factory-rabbitmq"
      - "RabbitMqSettings:Port=5672"
      - "RabbitMqSettings:Username=admin"
      - "RabbitMqSettings:Password=password"
      - "RabbitMqSettings:VirtualHost=/"
    depends_on:
      - promocode-factory-giving-to-customer-db
      - promocode-factory-preferences-api
      - promocode-factory-rabbitmq

  #Redis Cache
  promocode-factory-redis:
    image: "redis:7-alpine"
    container_name: 'promocode-factory-redis'
    restart: always
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  #Preferences Api
  promocode-factory-preferences-api:
    build: src/Pcf.Preferences/
    container_name: 'promocode-factory-preferences-api'
    restart: always
    ports:
      - "8094:8080"
    environment:
      - "ConnectionStrings:DefaultConnection=Data Source=/app/data/preferences.db"
      - "ConnectionStrings:Redis=promocode-factory-redis:6379"
      - "CacheSettings:UseRedis=true"
    volumes:
      - preferences_data:/app/data
    depends_on:
      - promocode-factory-redis

  #RabbitMQ Message Broker
  promocode-factory-rabbitmq:
    image: "rabbitmq:3-management-alpine"
    container_name: 'promocode-factory-rabbitmq'
    restart: always
    ports:
      - "5672:5672"   # AMQP порт
      - "15672:15672" # Web UI порт
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=password
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

volumes:
  mongodb_data:
  redis_data:
  preferences_data:
  rabbitmq_data: