<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç SignalR - Customers</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        input {
            padding: 8px;
            margin: 5px;
            width: 200px;
        }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç SignalR - Customers Hub</h1>

    <div>
        <label>URL —Å–µ—Ä–≤–µ—Ä–∞:</label>
        <input type="text" id="serverUrl" value="http://localhost:8095" />
        <button onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button onclick="disconnect()" id="disconnectBtn" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
    </div>

    <div id="status" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>

    <h3>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</h3>
    <div id="log" class="log"></div>

    <script>
        let connection = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (connected) {
                statusDiv.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                statusDiv.className = 'status connected';
                disconnectBtn.disabled = false;
            } else {
                statusDiv.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                statusDiv.className = 'status disconnected';
                disconnectBtn.disabled = true;
            }
        }

        function connect() {
            const serverUrl = document.getElementById('serverUrl').value;
            const hubUrl = `${serverUrl}/hubs/customers`;

            log(`–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ${hubUrl}...`);

            connection = new signalR.HubConnectionBuilder()
                .withUrl(hubUrl, {
                    skipNegotiation: false,
                    transport: signalR.HttpTransportType.WebSockets | signalR.HttpTransportType.LongPolling
                })
                .withAutomaticReconnect()
                .build();

            connection.on("CustomerCreated", (customer) => {
                log(`‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç: ${JSON.stringify(customer, null, 2)}`);
            });

            connection.on("CustomerUpdated", (customer) => {
                log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç: ${JSON.stringify(customer, null, 2)}`);
            });

            connection.on("CustomerDeleted", (customerId) => {
                log(`‚ùå –£–¥–∞–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç: ${customerId}`);
            });

            connection.on("CustomersListUpdated", (customers) => {
                log(`üìã –û–±–Ω–æ–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤: ${JSON.stringify(customers, null, 2)}`);
            });

            connection.onreconnecting(() => {
                log('‚è≥ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                updateStatus(false);
            });

            connection.onreconnected(() => {
                log('‚úÖ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–æ');
                updateStatus(true);
            });

            connection.onclose(() => {
                log('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                updateStatus(false);
            });

            connection.start()
                .then(() => {
                    log('‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ SignalR Hub');
                    updateStatus(true);
                })
                .catch((err) => {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${err.toString()}`);
                    updateStatus(false);
                    console.error('–û—à–∏–±–∫–∞ SignalR:', err);
                });
        }

        function disconnect() {
            if (connection) {
                connection.stop()
                    .then(() => {
                        log('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç SignalR Hub');
                        updateStatus(false);
                    })
                    .catch((err) => {
                        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏: ${err.toString()}`);
                    });
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.');
        };
    </script>
</body>
</html>

